<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="富足管家">
    <meta name="theme-color" content="#18181b">

    <link id="app-icon" rel="apple-touch-icon" href="">
    <link id="fav-icon" rel="icon" href="">

    <title>富足管家 - 手動記帳版</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #f3f4f6;       
            --card-bg: #ffffff;        
            --card-bg-dark: #18181b;   
            --text-main: #09090b;      
            --text-light: #f4f4f5;     
            --text-muted: #71717a;     
            --border-color: #000000;   
            --accent-color: #ff6600;   
            --up-color: #ef4444;       
            --down-color: #10b981;     
            --short-color: #d946ef;    
            --border-width: 3px;       
            --shadow-offset: 4px;      
            --radius: 12px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(#d1d5db 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--text-main);
            margin: 0;
            padding-top: max(20px, env(safe-area-inset-top));
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            padding-bottom: calc(100px + env(safe-area-inset-bottom));
            -webkit-overflow-scrolling: touch;
        }

        .num-font { font-family: 'Menlo', 'Courier New', monospace; font-weight: 700; letter-spacing: -0.5px; }

        /* Header */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin: 10px 20px 24px 20px; background: var(--card-bg-dark); color: var(--text-light);
            padding: 16px 20px; border: var(--border-width) solid var(--border-color);
            border-radius: var(--radius); box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--border-color);
            position: sticky; top: 10px; z-index: 50; backdrop-filter: blur(10px);
        }
        .brand { font-size: 1.1rem; font-weight: 900; color: var(--text-light); display: flex; align-items: center; gap: 8px; text-transform: uppercase; }
        .brand i { color: var(--accent-color); }

        .refresh-btn {
            background: var(--card-bg); border: var(--border-width) solid var(--border-color);
            color: var(--text-main); padding: 8px 16px; border-radius: 999px;
            cursor: pointer; font-weight: 800; font-size: 0.85rem; display: flex; align-items: center; gap: 6px;
            transition: transform 0.1s; box-shadow: 2px 2px 0 var(--border-color);
        }
        .refresh-btn:active { transform: scale(0.95); box-shadow: 0 0 0; }
        .refresh-btn i { color: var(--text-muted); }
        .refresh-btn.loading { background: var(--accent-color); color: white; }

        /* Rates */
        .rates-ticker {
            display: flex; gap: 12px; overflow-x: auto; margin: 0 20px 24px 20px; padding-bottom: 8px;
            scrollbar-width: none; -ms-overflow-style: none;
        }
        .rates-ticker::-webkit-scrollbar { display: none; }
        .rate-badge {
            background: var(--card-bg); padding: 8px 14px; border: 2px solid var(--border-color);
            border-radius: 8px; font-size: 0.85rem; font-weight: 700; color: var(--text-main);
            white-space: nowrap; box-shadow: 2px 2px 0 rgba(0,0,0,0.1); display: flex; align-items: center; gap: 5px;
        }
        .rate-badge span { color: var(--accent-color); margin-left: 4px; }
        .live-dot { width: 8px; height: 8px; background: var(--down-color); border-radius: 50%; display: inline-block; animation: blink 2s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        /* Dashboard */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 0 20px 24px 20px; }
        @media (min-width: 768px) { .dashboard-grid { gap: 24px; } }
        .card {
            background: var(--card-bg); border: var(--border-width) solid var(--border-color);
            border-radius: var(--radius); padding: 20px; position: relative;
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--border-color);
        }
        .card.main { grid-column: span 2; background: var(--card-bg-dark); color: var(--text-light); }
        .card.main .card-label { color: #a1a1aa; }
        .card.main .card-value { color: var(--accent-color); font-size: 2rem; }
        .card-label { font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .card-value { font-size: 1.5rem; line-height: 1.2; }
        .card-sub { font-size: 0.85rem; margin-top: 8px; font-weight: 700; border-top: 2px solid #e5e7eb; padding-top: 5px; display: inline-block; }
        .text-up { color: var(--up-color); } .text-down { color: var(--down-color); }

        /* Tabs */
        .nav-tabs {
            display: flex; background: #e4e4e7; border: var(--border-width) solid var(--border-color);
            border-radius: var(--radius); margin: 0 20px 24px 20px;
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--border-color); padding: 4px;
        }
        .nav-tab {
            flex: 1; text-align: center; padding: 12px; font-weight: 800; font-size: 0.85rem;
            cursor: pointer; border-radius: calc(var(--radius) - 4px); color: var(--text-muted);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); white-space: nowrap;
        }
        .nav-tab.active { background: var(--accent-color); color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* List & History */
        .stock-list { margin: 0 20px; padding-bottom: 40px; }
        .broker-group {
            margin-bottom: 24px; border: var(--border-width) solid var(--border-color);
            border-radius: var(--radius); box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--border-color);
            background: var(--card-bg); overflow: hidden; -webkit-mask-image: -webkit-radial-gradient(white, black);
        }
        .broker-header {
            background: var(--card-bg-dark); color: var(--text-light); padding: 14px 16px;
            font-weight: 700; border-bottom: var(--border-width) solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        .broker-tag {
            background: var(--accent-color); color: var(--border-color); padding: 4px 10px;
            border-radius: 6px; font-size: 0.8rem; font-weight: 800; border: 2px solid var(--border-color);
        }
        .stock-item {
            padding: 16px; display: grid; grid-template-columns: 1.4fr 1fr 1fr; align-items: center;
            border-bottom: 2px solid #e5e7eb; cursor: pointer; background: #fff;
        }
        .stock-item:last-child { border-bottom: none; }
        .stock-item:active { background: #fef3c7; }
        .si-info h3 { margin: 0; font-size: 1.1rem; font-weight: 800; display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .si-sub { font-size: 0.8rem; color: var(--text-muted); font-family: 'Menlo', monospace; }
        .market-badge {
            font-size: 0.65rem; padding: 3px 6px; border: 2px solid var(--border-color);
            border-radius: 4px; font-weight: 800; background: #fff; color: #000;
        }
        .badge-future { background: var(--short-color); color: white; }
        .badge-history { background: #52525b; color: white; }

        .si-price { text-align: right; font-size: 1.1rem; }
        .si-change { text-align: right; display: flex; flex-direction: column; align-items: flex-end; }
        .change-pill {
            padding: 6px 10px; border: 2px solid var(--border-color); border-radius: 8px;
            font-size: 0.9rem; font-weight: 800; min-width: 75px; text-align: center;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.1);
        }
        .bg-up { background: var(--up-color); color: white; }
        .bg-down { background: var(--down-color); color: white; }

        /* FAB */
        .fab {
            position: fixed; bottom: calc(30px + env(safe-area-inset-bottom)); right: 24px;
            width: 64px; height: 64px; background: var(--accent-color);
            border: var(--border-width) solid var(--border-color); border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            color: var(--border-color); font-size: 2rem; box-shadow: 6px 6px 0 var(--border-color);
            cursor: pointer; z-index: 50; transition: transform 0.1s;
        }
        .fab:active { transform: scale(0.9); box-shadow: 2px 2px 0 var(--border-color); }

        /* Export Button */
        .export-btn {
            background: #fff; border: 2px solid var(--border-color); width: 100%;
            padding: 12px; font-weight: 800; margin-top: 20px; border-radius: 8px;
            display: flex; justify-content: center; gap: 10px; align-items: center;
            box-shadow: 4px 4px 0 var(--border-color); cursor: pointer;
        }
        .export-btn:active { transform: translate(2px,2px); box-shadow: 2px 2px 0 var(--border-color); }

        /* Generic Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            z-index: 100; display: none; justify-content: center; align-items: flex-end;
        }
        @media (min-width: 768px) { .modal-overlay { align-items: center; } }
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: var(--card-bg); width: 100%; max-width: 500px;
            border: var(--border-width) solid var(--border-color);
            border-radius: 20px 20px 0 0; padding: 24px 24px calc(24px + env(safe-area-inset-bottom)) 24px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @media (min-width: 768px) {
            .modal {
                width: 90%; border-radius: var(--radius); padding: 24px;
                box-shadow: 10px 10px 0 var(--border-color); animation: popIn 0.3s;
            }
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .modal h3 { 
            margin-top: 0; font-size: 1.3rem; border-bottom: 4px solid var(--accent-color); 
            display: inline-block; padding-bottom: 5px; margin-bottom: 24px;
        }
        
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 0.9rem; font-weight: 700; margin-bottom: 8px; color: var(--text-main); }
        .form-input {
            width: 100%; background: #f9fafb; border: 2px solid var(--border-color);
            color: var(--text-main); padding: 14px; border-radius: 8px; 
            font-size: 16px !important; font-family: 'Menlo', monospace; -webkit-appearance: none;
        }
        .form-input:focus { outline: none; background: #fff; border-color: var(--accent-color); }
        
        /* Highlight for the new Price input */
        .form-input.highlight { border-color: var(--accent-color); background: #fff7ed; }

        .radio-group { display: flex; gap: 10px; }
        .radio-option {
            flex: 1; text-align: center; padding: 12px; border: 2px solid var(--border-color);
            border-radius: 8px; cursor: pointer; font-weight: 700; background: #fff; color: var(--text-muted);
            transition: all 0.1s; font-size: 0.9rem;
        }
        .radio-option.active { background: var(--card-bg-dark); color: var(--accent-color); border-color: var(--card-bg-dark); }
        .radio-option.active.short { background: var(--short-color); color: white; border-color: var(--short-color); }
        
        .btn-group { display: flex; gap: 15px; margin-top: 30px; }
        .btn { 
            flex: 1; padding: 16px; border-radius: 10px; border: 2px solid var(--border-color);
            font-size: 0.9rem; font-weight: 800; cursor: pointer; box-shadow: 4px 4px 0 var(--border-color);
            transition: all 0.1s; display: flex; justify-content: center; align-items: center; gap: 5px;
        }
        .btn:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 var(--border-color); }
        .btn-primary { background: var(--accent-color); color: var(--border-color); }
        .btn-cancel { background: #fff; color: var(--text-main); }
        .btn-close-pos { background: var(--card-bg-dark); color: #fff; }
        .btn-delete { background: var(--up-color); color: white; }
        
        .empty-state { border: 3px dashed var(--text-muted); border-radius: var(--radius); padding: 50px 20px; text-align: center; color: var(--text-muted); font-weight: 700; margin: 0 20px; }

        /* Toast Notifications */
        .toast-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 200; width: 90%; max-width: 400px;
        }
        .toast {
            background: var(--card-bg-dark); color: #fff; padding: 16px; margin-bottom: 10px;
            border-radius: 8px; border: 2px solid var(--border-color);
            box-shadow: 4px 4px 0 var(--border-color);
            display: flex; align-items: center; justify-content: space-between;
            animation: slideDown 0.3s ease-out; font-weight: 700; font-size: 0.9rem;
        }
        .toast.error { background: var(--up-color); }
        .toast.success { background: var(--down-color); }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(-20px); } }

        /* Secondary Modals (Confirm/ClosePos) */
        .modal-sm { max-width: 350px !important; }
        .text-center { text-align: center; }
        .modal-text { font-size: 1.1rem; font-weight: 600; margin-bottom: 24px; line-height: 1.5; }
        .position-summary { 
            background: #f4f4f5; padding: 12px; border-radius: 8px; border: 2px solid #e4e4e7;
            margin-bottom: 20px; font-family: 'Menlo', monospace; font-size: 0.9rem;
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="brand">
            <i class="fa-solid fa-layer-group"></i> WEALTH<span style="color:var(--accent-color)">MASTER</span>
        </div>
        <!-- 更改按鈕功能為純演示 -->
        <button class="refresh-btn" onclick="fetchRealPrices(true)" id="refreshBtn">
            <i class="fa-solid fa-dice"></i> DEMO 模擬數據
        </button>
    </div>

    <div class="rates-ticker">
        <div class="rate-badge"><i class="fa-solid fa-clock"></i> <span id="last-update">--:--</span></div>
        <div class="rate-badge">USD <div class="live-dot"></div> <span id="rate-us" class="num-font">32.50</span></div>
        <div class="rate-badge">JPY <div class="live-dot"></div> <span id="rate-jp" class="num-font">0.2150</span></div>
    </div>

    <div class="dashboard-grid">
        <div class="card main">
            <div class="card-label">NET EQUITY (TWD) 淨值總額</div>
            <div class="card-value num-font" id="total-assets">NT$ --</div>
        </div>
        <div class="card">
            <div class="card-label">TOTAL P/L 總損益</div>
            <div class="card-value small num-font" id="total-pl">--</div>
            <div class="card-sub num-font" id="total-roi">--%</div>
        </div>
        <div class="card">
            <div class="card-label" id="sub-asset-label">TW/FUT ASSETS 台股期貨</div>
            <div class="card-value small num-font" id="sub-assets">--</div>
        </div>
    </div>

    <div class="nav-tabs">
        <div class="nav-tab active" id="tab-tw" onclick="switchTab('TW')">TW MARKET 台股</div>
        <div class="nav-tab" id="tab-us" onclick="switchTab('US')">US / GLOBAL 美股全球</div>
        <div class="nav-tab" id="tab-his" onclick="switchTab('HIS')">HISTORY 歷史</div>
    </div>

    <div class="stock-list" id="stock-list"></div>

    <div class="fab" id="fab-add" onclick="openModal()"><i class="fa-solid fa-plus"></i></div>

    <!-- Main Edit/Add Modal -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <h3>EDIT POSITION 編輯部位</h3>
            <input type="hidden" id="edit-id">
            
            <div class="form-group">
                <label class="form-label">ASSET TYPE 商品類型</label>
                <div class="radio-group">
                    <div class="radio-option active" id="type-stock" onclick="setType('stock')">STOCK 現股</div>
                    <div class="radio-option" id="type-future" onclick="setType('future')">FUTURE 期貨</div>
                </div>
                <input type="hidden" id="inp-type" value="stock">
            </div>

            <div class="form-group">
                <label class="form-label">SYMBOL 代號 (Yahoo Finance)</label>
                <input type="text" id="inp-symbol" class="form-input" placeholder="e.g. 2330.TW or AAPL">
            </div>
            <div class="form-group">
                <label class="form-label">NAME 商品名稱</label>
                <input type="text" id="inp-name" class="form-input" placeholder="e.g. TSMC">
            </div>
            <div class="form-group">
                <label class="form-label">BROKER 券商</label>
                <input type="text" id="inp-broker" class="form-input" placeholder="e.g. Yuanta">
            </div>

            <!-- New Field for Manual Price Update -->
            <div class="form-group">
                <label class="form-label" style="color:var(--accent-color);">CURRENT MARKET PRICE 目前市價 <i class="fa-solid fa-pen"></i></label>
                <input type="number" id="inp-current-price" class="form-input highlight" placeholder="Enter current market price">
            </div>

            <div class="form-group" id="group-direction" style="display:none;">
                <label class="form-label">DIRECTION 多空方向</label>
                <div class="radio-group">
                    <div class="radio-option active" id="dir-long" onclick="setDirection(1)">LONG 做多</div>
                    <div class="radio-option" id="dir-short" onclick="setDirection(-1)">SHORT 做空</div>
                </div>
                <input type="hidden" id="inp-direction" value="1">
            </div>

            <div class="form-group">
                <label class="form-label" id="label-qty">QUANTITY 股數</label>
                <input type="number" id="inp-qty" class="form-input" placeholder="0">
            </div>
            <div class="form-group">
                <label class="form-label" id="label-cost">AVG COST 平均成本</label>
                <input type="number" id="inp-cost" class="form-input" placeholder="0.00">
            </div>

            <div id="group-future-specs" style="display:none;">
                <div class="form-group">
                    <label class="form-label">MULTIPLIER 合約乘數</label>
                    <input type="number" id="inp-multiplier" class="form-input" value="2000">
                </div>
                <div class="form-group">
                    <label class="form-label">MARGIN 保證金 (成本)</label>
                    <input type="number" id="inp-margin" class="form-input" placeholder="For equity calc">
                </div>
            </div>

            <div class="btn-group" id="btn-group-main">
                <button class="btn btn-cancel" onclick="closeModal()">CANCEL 取消</button>
                <button class="btn btn-primary" onclick="saveStock()">SAVE 儲存</button>
            </div>
            <div class="btn-group" id="btn-group-actions" style="display:none; margin-top:15px;">
                <button class="btn btn-delete" onclick="confirmDelete()">DELETE 刪除</button>
                <button class="btn btn-close-pos" onclick="openClosePosModal()">
                    <i class="fa-solid fa-gavel"></i> CLOSE 平倉
                </button>
            </div>
        </div>
    </div>

    <!-- Close Position Modal -->
    <div class="modal-overlay" id="modal-close-pos">
        <div class="modal modal-sm">
            <h3>CLOSE POSITION 平倉</h3>
            <div class="position-summary" id="close-summary">
                TSMC 2330.TW<br>
                Cost: 600
            </div>
            <div class="form-group">
                <label class="form-label">EXECUTION PRICE 成交價格</label>
                <input type="number" id="inp-close-price" class="form-input" placeholder="Enter price">
            </div>
            <div class="btn-group">
                <button class="btn btn-cancel" onclick="closeClosePosModal()">BACK 返回</button>
                <button class="btn btn-primary" onclick="executeClosePos()">CONFIRM 確認</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="modal-confirm-delete">
        <div class="modal modal-sm">
            <h3>CONFIRM 刪除確認</h3>
            <div class="modal-text text-center">
                Are you sure you want to delete this position?<br>
                確定要刪除此部位嗎？
            </div>
            <div class="btn-group">
                <button class="btn btn-cancel" onclick="closeConfirmDelete()">CANCEL 取消</button>
                <button class="btn btn-delete" onclick="executeDelete()">DELETE 刪除</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

<script>
    function generateAppIcon() {
        const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 512;
        const ctx = canvas.getContext('2d'); ctx.fillStyle = '#18181b'; ctx.fillRect(0, 0, 512, 512);
        ctx.strokeStyle = '#27272a'; ctx.lineWidth = 4;
        for(let i=0; i<512; i+=64) { ctx.beginPath();ctx.moveTo(i,0);ctx.lineTo(i,512);ctx.stroke(); ctx.beginPath();ctx.moveTo(0,i);ctx.lineTo(512,i);ctx.stroke();}
        ctx.strokeStyle = '#ff6600'; ctx.lineWidth = 30; ctx.strokeRect(15, 15, 482, 482);
        ctx.font = '900 240px "Arial Black", sans-serif'; ctx.fillStyle = '#f4f4f5';
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.shadowColor = '#000'; ctx.shadowOffsetX=10; ctx.shadowOffsetY=10; ctx.shadowBlur=0;
        ctx.fillText('WM', 256, 256);
        const url = canvas.toDataURL('image/png');
        document.getElementById('app-icon').href = url; document.getElementById('fav-icon').href = url;
    }

    let portfolio = [];
    let historyData = [];
    let rates = { 'USD': 32.5, 'JPY': 0.215, 'TWD': 1 };
    let currentView = 'TW';

    function init() {
        generateAppIcon();
        const savedData = localStorage.getItem('wealthMasterUltimateData');
        if (savedData) portfolio = JSON.parse(savedData);
        else portfolio = [{ id: 1, type: 'stock', symbol: '2330.TW', name: '台積電', broker: '元大證券', qty: 1000, cost: 600, currency: 'TWD', direction: 1, multiplier: 1, price: 600 }];
        const savedHistory = localStorage.getItem('wealthMasterHistoryData');
        if (savedHistory) historyData = JSON.parse(savedHistory);
        render();
        // 變更點：不再自動呼叫 fetchRealPrices，避免覆蓋手動輸入
    }

    function switchTab(view) {
        currentView = view;
        document.getElementById('tab-tw').className = `nav-tab ${view === 'TW' ? 'active' : ''}`;
        document.getElementById('tab-us').className = `nav-tab ${view === 'US' ? 'active' : ''}`;
        document.getElementById('tab-his').className = `nav-tab ${view === 'HIS' ? 'active' : ''}`;
        document.getElementById('fab-add').style.display = view === 'HIS' ? 'none' : 'flex';
        render();
    }

    // --- 模擬資料邏輯 (僅在按下 Demo 按鈕時觸發) ---
    function fetchRealPrices(isDemo = false) {
        if(!isDemo) return;

        const btn = document.getElementById('refreshBtn');
        btn.classList.add('loading');
        btn.innerHTML = '<i class="fa-solid fa-dice"></i> 產生中...';

        const symbols = [...new Set(portfolio.map(p => p.symbol))];

        setTimeout(() => {
            const mockPrices = {};
            // 模擬匯率波動
            const newUS = 32.5 + (Math.random() - 0.5) * 0.2;
            const newJP = 0.215 + (Math.random() - 0.5) * 0.005;
            
            mockPrices['USDTWD=X'] = { price: newUS };
            mockPrices['JPYTWD=X'] = { price: newJP };

            // 模擬股價波動
            symbols.forEach(sym => {
                let base = sym.includes('2330') ? 820 : (sym.includes('AAPL') ? 175 : 100);
                const exist = portfolio.find(p=>p.symbol===sym);
                const curr = exist ? (exist.price||exist.cost||base) : base;
                // 1.5% 隨機波動
                const chg = (Math.random()-0.5)*curr*0.015;
                
                // 修正後的幣別邏輯
                let currCode = 'USD';
                if(sym.includes('.TW') || sym.includes('.TWO')) {
                    currCode = 'TWD';
                } else if(sym.endsWith('.T')) {
                    currCode = 'JPY';
                }
                
                mockPrices[sym] = { 
                    price: curr+chg, 
                    changePercent: (chg/curr)*100, 
                    currency: currCode 
                };
            });
            onSuccess(mockPrices);
        }, 800);
    }

    function onSuccess(prices) {
        const btn = document.getElementById('refreshBtn');
        btn.classList.remove('loading');
        btn.innerHTML = '<i class="fa-solid fa-dice"></i> DEMO 模擬數據';
        document.getElementById('last-update').innerText = new Date().toLocaleTimeString('en-US',{hour12:false});

        // 1. 更新匯率
        if(prices['USDTWD=X']) {
            rates['USD'] = prices['USDTWD=X'].price;
            document.getElementById('rate-us').innerText = rates['USD'].toFixed(2);
        }
        if(prices['JPYTWD=X']) {
            rates['JPY'] = prices['JPYTWD=X'].price;
            document.getElementById('rate-jp').innerText = rates['JPY'].toFixed(4);
        }

        // 2. 更新股價
        portfolio.forEach(p => {
            if(prices[p.symbol]) {
                const d = prices[p.symbol]; 
                p.price = d.price; 
                p.changePct = d.changePercent;
                if(d.currency) p.currency = d.currency;
            } else if(!p.price) {
                p.price = p.cost;
            }
        });
        saveDataLocally(); render();
        showToast('模擬數據已生成', 'success');
    }

    function render() {
        const listEl = document.getElementById('stock-list');
        listEl.innerHTML = '';

        if (currentView === 'HIS') {
            document.getElementById('sub-asset-label').innerText = "REALIZED P/L 已實現";
            let totalRealized = 0;
            historyData.forEach(h => { let r = rates[h.currency] || 1; totalRealized += h.realizedPL * r; });
            document.getElementById('sub-assets').innerText = 'NT$ ' + Math.round(totalRealized).toLocaleString();
            listEl.innerHTML = `<div class="export-btn" onclick="exportHistoryCSV()"><i class="fa-solid fa-file-csv"></i> EXPORT TO EXCEL</div>`;
            if(historyData.length === 0) listEl.innerHTML += '<div class="empty-state">無歷史平倉紀錄</div>';
            else {
                historyData.forEach(h => {
                    const isWin = h.realizedPL >= 0;
                    listEl.innerHTML += `
                    <div class="stock-item" style="background:#f4f4f5;">
                        <div class="si-info"><h3>${h.name} <span class="market-badge badge-history">SOLD</span></h3><span class="si-sub">${h.closeDate} • ${h.broker}</span></div>
                        <div class="si-price num-font"><div>${Math.round(h.closePrice*100)/100}</div><div style="font-size:0.75rem; color:#71717a;">COST: ${h.cost}</div></div>
                        <div class="si-change num-font"><span style="font-size:1rem; font-weight:800;" class="${isWin?'text-up':'text-down'}">${isWin?'+':''}${Math.round(h.realizedPL).toLocaleString()}</span><span style="font-size:0.75rem; color:#71717a;">${h.currency}</span></div>
                    </div>`;
                });
            }
            return;
        }

        const filteredList = portfolio.filter(p => {
            if (currentView === 'TW') return p.currency === 'TWD';
            if (currentView === 'US') return p.currency !== 'TWD'; 
            return true;
        });

        let totalAssetTWD=0, totalPLTWD=0, totalCostBasisTWD=0, subAssetTWD=0;

        portfolio.forEach(p => {
             const currPrice = p.price || p.cost;
             const rate = rates[p.currency] || 1;
             const mult = p.multiplier || 1;
             const dir = p.direction || 1;
             const plNative = (currPrice - p.cost) * p.qty * mult * dir;
             const plTWD = plNative * rate;
             
             let assetValTWD = 0;
             if (p.type === 'future') {
                 assetValTWD = ((p.margin||0) + plNative) * rate; 
                 totalCostBasisTWD += (p.margin||0)*rate;
             } else {
                 assetValTWD = (currPrice * p.qty * mult) * rate;
                 totalCostBasisTWD += (p.cost * p.qty * mult * rate);
             }

             totalAssetTWD += assetValTWD;
             totalPLTWD += plTWD;
             
             const isTW = p.currency === 'TWD';
             if (currentView === 'TW' && isTW) subAssetTWD += assetValTWD;
             if (currentView === 'US' && !isTW) subAssetTWD += assetValTWD;
        });

        const subLabel = currentView === 'TW' ? 'TW ASSETS 台股資產' : 'US/GLOBAL 美股全球';
        document.getElementById('sub-asset-label').innerText = subLabel;
        document.getElementById('sub-assets').innerText = 'NT$ ' + Math.round(subAssetTWD).toLocaleString();
        document.getElementById('total-assets').innerText = 'NT$ ' + Math.round(totalAssetTWD).toLocaleString();
        
        const totalROI = totalCostBasisTWD > 0 ? (totalPLTWD / totalCostBasisTWD) * 100 : 0;
        document.getElementById('total-pl').innerText = (totalPLTWD>=0?'+':'') + Math.round(totalPLTWD).toLocaleString();
        document.getElementById('total-pl').className = 'card-value small num-font ' + (totalPLTWD>=0?'text-up':'text-down');
        document.getElementById('total-roi').innerText = (totalPLTWD>=0?'▲':'▼') + Math.abs(totalROI).toFixed(2) + '%';
        document.getElementById('total-roi').className = 'card-sub num-font ' + (totalPLTWD>=0?'text-up':'text-down');

        if(filteredList.length === 0) {
            listEl.innerHTML = '<div class="empty-state"><i class="fa-solid fa-box-open" style="font-size:2rem;margin-bottom:10px;display:block"></i>NO POSITIONS 無持倉</div>';
        } else {
            const grouped = filteredList.reduce((acc, p) => {
                const key = p.broker || '未分類';
                if(!acc[key]) acc[key] = []; acc[key].push(p); return acc;
            }, {});

            Object.keys(grouped).sort().forEach(broker => {
                const stocks = grouped[broker];
                let brokerEquity = 0;
                let brokerHtml = '';

                stocks.forEach(p => {
                    const currPrice = p.price || p.cost;
                    const rate = rates[p.currency] || 1;
                    const mult = p.multiplier || 1;
                    const dir = p.direction || 1;
                    const plNative = (currPrice - p.cost) * p.qty * mult * dir;
                    
                    let assetValTWD = 0;
                    if (p.type === 'future') assetValTWD = ((p.margin||0) + plNative) * rate;
                    else assetValTWD = (currPrice * p.qty * mult) * rate;
                    brokerEquity += assetValTWD;

                    let roi = 0;
                    if(p.type === 'future') roi = (p.margin > 0) ? (plNative / p.margin) * 100 : 0;
                    else roi = ((currPrice - p.cost) / p.cost) * 100;

                    const isUp = plNative >= 0;
                    
                    // Display Symbol logic
                    let symDisplay = '$';
                    if (p.currency === 'TWD') symDisplay = 'NT$';
                    else if (p.currency === 'JPY') symDisplay = '¥';
                    else if (p.currency === 'USD') symDisplay = '$';
                    else symDisplay = p.currency + ' ';

                    let tags = `<span class="market-badge">${p.currency}</span>`;
                    if(p.type === 'future') {
                        tags += `<span class="market-badge badge-future">FUT 期</span>`;
                        if(p.direction === -1) tags += `<span class="market-badge badge-future">SHORT 空</span>`;
                    }

                    let priceSubHtml = '';
                    if(p.type === 'future') {
                        const notional = Math.round(currPrice * p.qty * mult).toLocaleString();
                        const lev = p.margin > 0 ? (currPrice * p.qty * mult / p.margin).toFixed(1) : '-';
                        priceSubHtml = `<div style="font-size:0.75rem; color:#71717a; margin-top:2px;">AVG: ${p.cost}</div><div style="font-size:0.75rem; color:var(--accent-color); font-weight:700; margin-top:2px;">MARGIN 保: $${Number(p.margin).toLocaleString()}</div><div style="font-size:0.65rem; color:#71717a; margin-top:2px;">Val: $${notional} | Lev: ${lev}x</div>`;
                    } else {
                        priceSubHtml = `<div style="font-size:0.75rem; color:#71717a; margin-top:4px;">COST: ${p.cost}</div>`;
                    }

                    brokerHtml += `
                        <div class="stock-item" onclick="openModal(${p.id})">
                            <div class="si-info"><h3>${p.name} ${tags}</h3><span class="si-sub">${p.symbol} / ${p.qty}${p.type==='future'?'口':'股'}</span></div>
                            <div class="si-price num-font"><div>${symDisplay} ${currPrice.toLocaleString()}</div>${priceSubHtml}</div>
                            <div class="si-change num-font">
                                <div class="change-pill ${isUp?'bg-up':'bg-down'}">${isUp?'+':''}${roi.toFixed(2)}%</div>
                                <span style="font-size:0.75rem; margin-top:4px; font-weight:700; color:${isUp?'var(--up-color)':'var(--down-color)'}">${isUp?'+':''}${Math.round(plNative).toLocaleString()}</span>
                            </div>
                        </div>`;
                });
                listEl.innerHTML += `<div class="broker-group"><div class="broker-header"><span><i class="fa-solid fa-briefcase"></i> ${broker}</span><span class="broker-tag num-font">$${Math.round(brokerEquity).toLocaleString()}</span></div>${brokerHtml}</div>`;
            });
        }
    }

    // Modal & Toast Utilities
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<span>${message}</span> <i class="fa-solid ${type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i>`;
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.animation = 'fadeOut 0.3s forwards';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function setType(type) { document.getElementById('inp-type').value=type; document.getElementById('type-stock').className=`radio-option ${type==='stock'?'active':''}`; document.getElementById('type-future').className=`radio-option ${type==='future'?'active':''}`; const isFut=type==='future'; document.getElementById('group-direction').style.display=isFut?'block':'none'; document.getElementById('group-future-specs').style.display=isFut?'block':'none'; document.getElementById('label-qty').innerText=isFut?'LOTS 口數':'SHARES 股數'; document.getElementById('label-cost').innerText=isFut?'AVG PRICE 建倉均價':'AVG COST 平均成本'; }
    function setDirection(dir) { document.getElementById('inp-direction').value=dir; document.getElementById('dir-long').className=`radio-option ${dir==1?'active':''}`; document.getElementById('dir-short').className=`radio-option ${dir==-1?'active short':''}`; }
    
    function openModal(id) { 
        document.getElementById('modal-overlay').classList.add('active'); 
        const ba=document.getElementById('btn-group-actions'); 
        const bm=document.getElementById('btn-group-main'); 
        if(id){ 
            const p=portfolio.find(x=>x.id==id); 
            document.getElementById('edit-id').value=p.id; 
            setType(p.type||'stock'); 
            document.getElementById('inp-symbol').value=p.symbol; 
            document.getElementById('inp-name').value=p.name; 
            document.getElementById('inp-broker').value=p.broker; 
            document.getElementById('inp-qty').value=p.qty; 
            document.getElementById('inp-cost').value=p.cost; 
            document.getElementById('inp-current-price').value=p.price || p.cost; // Set Current Price
            setDirection(p.direction||1); 
            document.getElementById('inp-multiplier').value=p.multiplier||(p.type==='future'?2000:1); 
            document.getElementById('inp-margin').value=p.margin||''; 
            ba.style.display='flex'; 
        } else { 
            document.getElementById('edit-id').value=''; 
            setType('stock'); 
            document.getElementById('inp-symbol').value=''; 
            document.getElementById('inp-name').value=''; 
            document.getElementById('inp-broker').value=''; 
            document.getElementById('inp-qty').value=''; 
            document.getElementById('inp-cost').value=''; 
            document.getElementById('inp-current-price').value=''; // Empty for new
            document.getElementById('inp-margin').value=''; 
            document.getElementById('inp-multiplier').value='1'; 
            ba.style.display='none'; 
        } 
    }
    
    function closeModal() { document.getElementById('modal-overlay').classList.remove('active'); }
    
    function saveStock() { 
        const id=document.getElementById('edit-id').value; 
        const type=document.getElementById('inp-type').value; 
        const symbol=document.getElementById('inp-symbol').value.toUpperCase().trim(); 
        const name=document.getElementById('inp-name').value; 
        const broker=document.getElementById('inp-broker').value||'未分類'; 
        const qty=Number(document.getElementById('inp-qty').value); 
        const cost=Number(document.getElementById('inp-cost').value); 
        const currentPrice=Number(document.getElementById('inp-current-price').value); // Get user input price
        const direction=Number(document.getElementById('inp-direction').value); 
        const multiplier=Number(document.getElementById('inp-multiplier').value)||1; 
        const margin=Number(document.getElementById('inp-margin').value)||0; 
        
        if(!symbol||qty<=0) {
            showToast('Please fill all required fields 請填寫完整', 'error');
            return;
        }
        
        let currency='USD'; 
        if(symbol.includes('.TW') || symbol.includes('.TWO')) {
            currency = 'TWD';
        } else if (symbol.endsWith('.T')) {
            currency = 'JPY';
        }
        
        // 變更點：如果使用者輸入了市價，就用市價，否則預設為成本價
        const priceToSave = currentPrice > 0 ? currentPrice : cost;

        const newItem={id:id?Number(id):Date.now(), type, symbol, name, broker, qty, cost, currency, direction, multiplier, margin, price: priceToSave, changePct: 0}; 
        
        if(id){ 
            const idx=portfolio.findIndex(x=>x.id==id); 
            if(idx!==-1){ 
                newItem.changePct=portfolio[idx].changePct; // 保留原本的漲跌幅模擬（如果有的話）
                portfolio[idx]=newItem; 
            } 
        } else { 
            portfolio.push(newItem); 
        } 
        saveDataLocally(); 
        closeModal(); 
        render(); 
        showToast('Saved Successfully 儲存成功');
    }

    // Delete Flow
    function confirmDelete() {
        document.getElementById('modal-overlay').classList.remove('active');
        document.getElementById('modal-confirm-delete').classList.add('active');
    }
    function closeConfirmDelete() {
        document.getElementById('modal-confirm-delete').classList.remove('active');
        document.getElementById('modal-overlay').classList.add('active'); // Go back
    }
    function executeDelete() { 
        const id=document.getElementById('edit-id').value; 
        portfolio=portfolio.filter(x=>x.id!=id); 
        saveDataLocally(); 
        document.getElementById('modal-confirm-delete').classList.remove('active');
        render(); 
        showToast('Position Deleted 已刪除', 'error');
    }
    
    // Close Position Flow
    function openClosePosModal() {
        const id=document.getElementById('edit-id').value; 
        const p=portfolio.find(x=>x.id==id); 
        if(!p) return;
        
        document.getElementById('modal-overlay').classList.remove('active');
        document.getElementById('modal-close-pos').classList.add('active');
        
        // Populate Summary
        const defaultPrice = p.price || p.cost;
        document.getElementById('close-summary').innerHTML = `
            <div><strong>${p.name}</strong> (${p.symbol})</div>
            <div>Qty: ${p.qty} | Cost: ${p.cost}</div>
        `;
        document.getElementById('inp-close-price').value = defaultPrice;
    }

    function closeClosePosModal() {
        document.getElementById('modal-close-pos').classList.remove('active');
        document.getElementById('modal-overlay').classList.add('active'); // Go back
    }

    function executeClosePos() {
        const id=document.getElementById('edit-id').value; 
        const p=portfolio.find(x=>x.id==id); 
        if(!p) return;

        const closePriceStr = document.getElementById('inp-close-price').value;
        const closePrice=parseFloat(closePriceStr); 
        
        if(isNaN(closePrice)) {
            showToast('Invalid Price 價格錯誤', 'error');
            return;
        }

        const mult = p.multiplier||1; 
        const dir = p.direction||1;
        const plNative = (closePrice - p.cost) * p.qty * mult * dir;
        const historyItem = { ...p, closePrice: closePrice, closeDate: new Date().toISOString().split('T')[0], realizedPL: plNative, id: Date.now() };
        
        historyData.unshift(historyItem); 
        localStorage.setItem('wealthMasterHistoryData', JSON.stringify(historyData));
        portfolio = portfolio.filter(x=>x.id!=id); 
        saveDataLocally(); 
        
        document.getElementById('modal-close-pos').classList.remove('active');
        render(); 
        showToast(`Position Closed! P/L: ${Math.round(plNative).toLocaleString()}`);
        switchTab('HIS');
    }

    function exportHistoryCSV() {
        if(historyData.length===0) {
            showToast('No history data 無歷史資料', 'error');
            return;
        }
        let csv = "\uFEFF日期,代號,名稱,券商,方向,數量,成本,平倉價,幣別,損益\n";
        historyData.forEach(r => { const d=r.type==='future'?(r.direction===1?'多':'空'):'現股'; csv+=`${r.closeDate},${r.symbol},${r.name},${r.broker},${d},${r.qty},${r.cost},${r.closePrice},${r.currency},${r.realizedPL}\n`; });
        const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const link=document.createElement("a"); link.href=url; link.download=`History_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }

    function saveDataLocally() { localStorage.setItem('wealthMasterUltimateData', JSON.stringify(portfolio)); }
    init();
</script>
</body>
</html>
